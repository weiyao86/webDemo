<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="../Scripts/jquery-1.9.0.js"></script>
    <script src="../Scripts/jquery.easing.1.3.js"></script>
    <script src="../Scripts/Plugin/mousewheel/jquery.mousewheel.min.js"></script>
    <script>
//requestAnimationFrame 兼容
(function() {
    var verdons = ['ms', 'webkit', 'moz', 'o'],
        lastTime = 0;
    for (var i = 0, l = verdons.length; i < l && !window.requestAnimationFrame; i++) {
        window.requestAnimationFrame = window[verdons[i] + 'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[verdons[i] + 'CancelAnimationFrame'] || window[verdons[i] + 'CancelRequestAnimationFrame'];
    }
    if (!window.requestAnimationFrame) {
        window.requestAnimationFrame = function(fn) {

            var curTime = new Date().getTime(),
                timeTocall = Math.max(0, 16 - (curTime - lastTime)),
                id = window.setTimeout(function() {
                    fn(curTime + timeTocall);
                }, timeTocall);
            lastTime = curTime + timeTocall;
            return id;
        }
    }
    if (!window.cancelAnimationFrame) {
        window.cancelAnimationFrame = function(id) {
            window.clearTimeout(id);
        }
    }
})();


//由快到慢 ease out method  更多算法参考 src="../Scripts/jquery.easing.1.3.js">
/*
    t : current time,
    b : intial value,
    c : changed value,
    d : duration
*/
function easeOutQuart(t, b, c, d) {
    t /= d;
    t--;
    return -c * (t * t * t * t - 1) + b;
};

$(function() {
    var $snapHandle = $("#snap_handle"),
        $fixed = $("#fixed"),
        $wrap = $("#wrap"),
        $viewImg = $("#view_img"),
        //setSnapSize 方法内重新计算
        operatorW = $wrap.width(),
        operatorH = $wrap.height(),
        contentDim = {
            fw: $fixed.width(),
            fh: $fixed.height()
        },
        //setSnapSize 方法内重新计算
        zoomRatio = 0.4,
        zoomMin = 0.2,
        zoomMax = 1,
        preZoom = 0,
        ra, rh, ow, oh, na,
        objX = 0,
        objY = 0,
         timer = null,
        timer1 = null;

    $("#msg").html("zoomRatio=" + zoomRatio + " zoomMin=" + zoomMin + " zoomMax=" + zoomMax);
    $("#view_img").on("load.zoom error.zoom", function(e) {
        setSnapSize(this, e.type === 'load');

    }).each(function(idx, el) {
        var src = el.src;

        if (el.complete && el.naturalWidth !== undefined && el.naturalWidth !== 0) {
            return setSnapSize(el, true);
        }
        if (el.readyState === undefined || el.complete) {
            el.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
            el.src = src;
        }
    });

    // $snapHandle.on({
    //     mouseenter: function() {
    //         $fixed.animate({
    //             top: 100,
    //             left: 400,
    //             width: 500,
    //             height: 400,
    //             opacity: 1
    //         });
    //     },
    //     mouseleave: function(e) {
    //         $fixed.animate({
    //             top: e.pageY,
    //             left: e.pageX,
    //             width: 0,
    //             height: 0,
    //             opacity: 0
    //         });
    //     }
    // });

    function setSnapSize(that, success) {
        if (success) {
            var iratio = that.width / that.height;
            //reset size
            operatorW = $wrap.width();
            operatorH = $wrap.height();

            contentDim.fw = iratio * contentDim.fh > contentDim.fw ? contentDim.fw : iratio * contentDim.fh;
            contentDim.fh = contentDim.fw / iratio;

            $viewImg.css({
                width: contentDim.fw / zoomRatio,
                height: contentDim.fh / zoomRatio
            });

            $fixed.css({
                height: $fixed.width() / iratio
            });

            $snapHandle.css({
                width: contentDim.fw / that.width * operatorW, // zoomRatio*operatorW,
                height: contentDim.fh / that.height * operatorH // zoomRatio*operatorH
            });


        }
    }


    $("#btn").on('click', function() {
        // var objs = {
        //     disX: 100,
        //     disY: 30
        // };
        // ani(objs);
          var nw = 70,
             nh=40,
             l=177,
             t=65;

        $("#srl").empty();
        var perc = 100 * zoomRatio,
            curperc =  preZoom,//<100 ? 100 :preZoom,
            step = 0;


        var vw = contentDim.fw * operatorW / nw, //* operatorW/nw,
                vh = contentDim.fh * operatorH / nh, //* operatorH/nh,
                vl = -vw * (l / operatorW),
                vt = -vh * (t / operatorH) //;

        function zoomView() {
            step++;

            if (step < 20) {
                timer1 = window.requestAnimationFrame(zoomView);
            } else if (step == 20) {
                clearFrames();
            }

            var tickZoom = easeOutQuart(step, curperc, perc - curperc, 20);

            var ratio = tickZoom / perc;

            $viewImg.css({
                width: vw * ratio,
                height: vh * ratio,
                left: vl* ratio,
                top: vt * ratio
            });

            var str = '<p>'+vl+'====='+( vl* ratio)+'==='+perc+'=='+curperc+'</p>'

            $("#srl").append(str).scrollTop(99999);
            preZoom = tickZoom;
        }
        zoomView();
    });

    $snapHandle.on("mousedown", function(e) {
        drag(this, $wrap, e, {
            move: function(evt, objs) {
                if(!objs.disX && !objs.disY)return;
                clearFrames();
                ani(objs);
            }
        });
        e.preventDefault();
    });


    function ani(objs) {

        var iw = contentDim.fw / zoomRatio,
            ih = contentDim.fh / zoomRatio;

        var perc = 100 * objs.disX,
            topperc = 100 * objs.disY,
            curperc = objX,
            curpercY = objY,
            step = 0,
            ox = objs.disX / operatorW * iw,
            oy = objs.disY / operatorH * ih;

        function zoomView(t) {
            step++;

            if (step < 60) {
                timer = window.requestAnimationFrame(zoomView);
            } else if (step == 60) {
                clearFrames();
            }

            var tickZoom = easeOutQuart(step, curperc, perc - curperc, 60);
            var tickZoomY = easeOutQuart(step, curpercY, topperc - curpercY, 60);

            var ratio = tickZoom / perc;
            var ratioY = tickZoomY / topperc;

            $viewImg.css({
                left: -ox * ratio,
                top: -oy * ratioY
            });

            var str = "<p>" + tickZoom + '=====' + ratio + "</p>";
            $("#srl").append(str).scrollTop(99999);

            objX = tickZoom;
            objY = tickZoomY;
        }
        zoomView();
    }

    $snapHandle.on("mousewheel", function(e) {
        var x = e.pageX,
            y = e.pageY,
            left;

        //滑轮滚动累加/累减值为 1/100
        if (e.deltaY > 0) {
            zoomRatio += 1 / 10;
        } else {
            zoomRatio -= 1 / 10;
        }

        zoomRatio = Math.max(zoomRatio, zoomMin);
        zoomRatio = Math.min(zoomMax, zoomRatio);

        if (preZoom == zoomRatio) return;

        var pof = $(this).parent().offset();
        x = x - pof.left;
        y = y - pof.top;

        var w = $snapHandle.width(),
            h = $snapHandle.height(),
            nw = zoomRatio * operatorW,
            nh = zoomRatio * operatorH,
            l = x - (x - $snapHandle.position().left) / w * nw,
            t = y - (y - $snapHandle.position().top) / h * nh;

        l = Math.min(operatorW - nw, l);
        t = Math.min(operatorH - nh, t);

        l = Math.max(l, 0);
        t = Math.max(t, 0);


        $snapHandle.css({
            width: nw,
            height: nh,
            left: l,
            top: t
        });

        clearFrames();
        $("#srl").empty();
        var perc = 100 * zoomRatio,
            curperc =  preZoom,
            step = 0,
            vw = contentDim.fw * operatorW / nw, //* operatorW/nw,
            vh = contentDim.fh * operatorH / nh, //* operatorH/nh,
            vl = -vw * (l / operatorW),
            vt = -vh * (t / operatorH);

        function zoomView() {
            step++;

            if (step < 20) {
                timer1 = window.requestAnimationFrame(zoomView);
            }
            var tickZoom = easeOutQuart(step, curperc, perc - curperc, 20);

            var ratio = tickZoom / perc;

            $viewImg.css({
                width: vw * ratio,
                height: vh * ratio,
                left: vl* ratio,
                top: vt * ratio
            });

            var str = '<p>'+tickZoom+'</p>'
            $("#srl").append(str).scrollTop(99999);
            preZoom = tickZoom;
        }
        zoomView();
    });

    function clearFrames() {
        window.cancelAnimationFrame(timer);
        window.cancelAnimationFrame(timer1);

    }

    function drag(target, $parent, e, callback) {
        var $target = $(target),
            pos = {
                top: e.pageY - $target.position().top,
                left: e.pageX - $target.position().left
            },
            maxX = $parent && $parent.width() - $target.width(),
            maxY = $parent && $parent.height() - $target.height();
        if (window.attachEvent) {
            $target.one('selectstart', function() {
                return false;
            });
        } else {
            $target.css({
                "-moz-user-select": 'none',
                "-webkit-user-select": 'none'
            });
        }
        $(document).on({
            "mousemove.drag": function(evt) {
                var px = evt.pageX,
                    py = evt.pageY,
                    moveDisX = px - pos.left,
                    moveDisY = py - pos.top;

                if ($parent) {
                    moveDisX < 0 && (moveDisX = 0);
                    moveDisX > maxX && (moveDisX = maxX);
                    moveDisY < 0 && (moveDisY = 0);
                    moveDisY > maxY && (moveDisY = maxY);
                }

                $target.css({
                    top: moveDisY,
                    left: moveDisX
                });
                if (callback && typeof callback.move == "function") {
                    callback.move.call(null, evt, {
                        moveDisX: moveDisX + $target.width(),
                        moveDisY: moveDisY + $target.height(),
                        disX: moveDisX,
                        disY: moveDisY
                    });
                }

                evt.preventDefault();
            },
            "mouseup.drag": function(e) {
                $(document).off(".drag");
                e.preventDefault();
            }
        });
    }
});
    </script>
    <style>
        .wrap{position:absolute ;top:200px;left:20px;border:2px solid #f80;height:200px;background:#ccc;margin:auto;z-index:1;overflow:hidden;}
        .wrap img{height:100%;}
        .w-snap-handle{position:absolute;top:0;left:0;width:100px;height:100px;box-shadow:0 0 0 500px rgba(0,0,0,.6);cursor:crosshair;border:2px solid #999;}
        .fixed{position:fixed;top:100px;left:400px;width:500px;height:800px;background:#ccc;overflow:hidden;border:1px solid #f80;}

        .fixed img{position:absolute;top:0;left:0;border:none;}
        .msg{text-align:center; position:fixed;bottom:0;left:0;width:100%;height:25px;background:#fff;z-index:10;}
        .scroll{position:fixed;top:0;right:0;bottom:30px;width:800px;border:2px solid #f90;overflow:auto;}
    </style>
</head>
<body>
<input type="button" value="button" id="btn">
    <div id="wrap" class="wrap">
    <img src="../Res/aa.png" alt="">
    <div id="snap_handle" class="w-snap-handle"></div>
    </div>
    <div id="fixed" class="fixed">
        <img id="view_img" src="../Res/aa.png" alt="">
    </div>
    <div id="msg" class="msg"></div>
    <div id="srl" class="scroll"></div>
</body>
</html>