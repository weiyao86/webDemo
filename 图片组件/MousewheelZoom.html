<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="../Scripts/jquery-1.9.0.js"></script>
    <script src="../Scripts/jquery.easing.1.3.js"></script>
    <script src="../Scripts/Plugin/mousewheel/jquery.mousewheel.min.js"></script>
    <script>
    $(function(){
        var $snapHandle=$("#snap_handle"),
            $fixed=$("#fixed"),
            $wrap=$("#wrap"),
            $viewImg=$("#view_img"),
            operatorW=$wrap.width(),
            operatorH=$wrap.height(),
            contentDim={
                fw:$fixed.width(),
                fh:$fixed.height()
            }, zoomRatio=0.4,zoomMin=0.2,zoomMax=1,preZoom=0,
            ra,rh,ow,oh,na;

        $("#msg").html("zoomRatio="+zoomRatio+" zoomMin="+zoomMin+" zoomMax="+zoomMax);
       $("#view_img").on("load.zoom error.zoom", function(e) {
            setSnapSize(this, e.type === 'load');

        }).each(function(idx, el) {
            var src = el.src;

            if (el.complete && el.naturalWidth !== undefined && el.naturalWidth !== 0) {
                return setSnapSize(el, true);
            }
            if (el.readyState === undefined || el.complete) {
                el.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
                el.src = src;
            }
        });
        function setSnapSize(that,success){
            if(success){
                 var iratio = that.width / that.height;
                 //reset size
                 operatorW=$wrap.width();
                 operatorH=$wrap.height();

                contentDim.fw= iratio * contentDim.fh > contentDim.fw ? contentDim.fw : iratio * contentDim.fh;
                contentDim.fh = contentDim.fw / iratio;

                $viewImg.css({
                    width: contentDim.fw/zoomRatio,
                    height: contentDim.fh/zoomRatio
                });

                $snapHandle.css({
                    width: zoomRatio*operatorW,
                    height: zoomRatio*operatorH
                });


            }
        }
        $snapHandle.on("mousedown",function(e){
           drag(this, $wrap, e, {
                move: function(evt, objs) {
                    var iw = contentDim.fw / zoomRatio,
                        ih= contentDim.fh / zoomRatio;

                    $viewImg.css({
                        left: -objs.disX /operatorW * iw,
                        top: -objs.disY /operatorH * ih
                    });
                }
            });
            e.preventDefault();
        });

       $snapHandle.on("mousewheel", function(e) {
        var x = e.pageX,
            y = e.pageY,
            left;

            //滑轮滚动累加/累减值为 1/100
            if (e.deltaY > 0) {
                zoomRatio += 1 / 10;
            } else {
                zoomRatio -= 1 / 10;
            }

            zoomRatio = Math.max(zoomRatio, zoomMin);
            zoomRatio = Math.min(zoomMax, zoomRatio);

            if(preZoom ==zoomRatio)return;

            var pof = $(this).parent().offset();
            x = x - pof.left;
            y = y - pof.top;

            var w = $snapHandle.width(),
             h = $snapHandle.height(),
             nw = zoomRatio * operatorW,
             nh = zoomRatio * operatorH,
             l=x - (x - $snapHandle.position().left) / w * nw,
             t= y - (y - $snapHandle.position().top) / h * nh;

             l=Math.min(operatorW-nw,l);
             t=Math.min(operatorH-nh,t);

             l=Math.max(l,0);
             t=Math.max(t,0);


            $snapHandle.css({
                 width: nw,
                 height:nh,
                 left: l,
                 top:t
            });

           var vw=contentDim.fw/zoomRatio,
               vh=contentDim.fh/zoomRatio,
               vl=-vw*(l/operatorW),
               vt=-vh*(t/operatorH);


            $viewImg.css({
                 width:vw,//contentDim.fw *operatorW/nw,
                 height:vh,
                 left: vl,
                 top:vt
            });
            preZoom =zoomRatio;
        });

        function drag(target, $parent, e, callback) {
            var $target = $(target),
                pos = {
                    top: e.pageY - $target.position().top,
                    left: e.pageX - $target.position().left
                },
                maxX = $parent && $parent.width() - $target.outerWidth(),
                maxY = $parent && $parent.height() - $target.outerHeight();
            if (window.attachEvent) {
                $target.one('selectstart', function() {
                    return false;
                    //拖拽div时禁止选中内容
                    //-moz-user-select: none; -webkit-user-select: none;
                });
            } else {
                $target.css({
                    "-moz-user-select": 'none',
                    "-webkit-user-select": 'none'
                });
            }
            $(document).on({
                "mousemove.drag": function(evt) {
                    var px = evt.pageX,
                        py = evt.pageY,
                        moveDisX = px - pos.left,
                        moveDisY = py - pos.top;

                    if ($parent) {
                        moveDisX < 0 && (moveDisX = 0);
                        moveDisX > maxX && (moveDisX = maxX);
                        moveDisY < 0 && (moveDisY = 0);
                        moveDisY > maxY && (moveDisY = maxY);
                    }

                    $target.css({
                        top: moveDisY,
                        left: moveDisX
                    });
                    if (callback && typeof callback.move == "function") {
                        callback.move.call(null, evt, {
                            moveDisX: moveDisX + $target.width(),
                            moveDisY: moveDisY + $target.height(),
                            disX: moveDisX,
                            disY: moveDisY
                        });
                    }

                    evt.preventDefault();
                },
                "mouseup.drag": function(e) {
                    $(document).off(".drag");
                    e.preventDefault();
                }
            });
        }
    });
    </script>
    <style>
        .wrap{position:absolute ;top:200px;left:20px;border:1px solid #f80;height:200px;background:#ccc;margin:auto;z-index:1;overflow:hidden;}
        .wrap img{height:100%;}
        .w-snap-handle{position:absolute;top:0;left:0;width:100px;height:100px;box-shadow:0 0 0 500px rgba(0,0,0,.6);}
        .fixed{position:fixed;top:100px;left:400px;width:500px;height:400px;background:#ccc;overflow:hidden;border:1px solid #f80;}
        .fixed img{position:absolute;top:0;left:0;border:none;}
        .msg{text-align:center; position:fixed;bottom:0;left:0;width:100%;height:25px;background:#fff;z-index:10;}
    </style>
</head>
<body>
    <div id="wrap" class="wrap">
    <img src="../Res/aa.png" alt="">
    <div id="snap_handle" class="w-snap-handle"></div>
    </div>
    <div id="fixed" class="fixed">
        <img id="view_img" src="../Res/aa.png" alt="">
    </div>
        <div id="msg" class="msg"></div>
</body>
</html>