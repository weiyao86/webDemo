<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    .canvas{
      border:1px solid;
      margin-top:1000px;
      position: relative;
    }
    #canvas,#cavs{
      border:1px solid #f00;
    }
    #teach{
      border:3px solid;
    }
    p{
      height:200px;
    }
    .teach{
      position: relative;
      top:1000px;
    }
  </style>
</head>
<body>
  <!-- <div class="teach"> -->
   <canvas id="teach" height="400" width="750"></canvas>
   <!-- </div> -->
   <canvas id="cavs" height="400" width="750"></canvas>
   <script>
    window.getPagePoint=function(obj){
            var x=obj.offsetLeft;
            var y=obj.offsetTop;
            while(obj=obj.offsetParent){
              x+=obj.offsetLeft;
              y+=obj.offsetTop;
               // console.log(obj)
            }

            return {
              l:x,t:y     
            }
       }
     const teach = document.getElementById('teach');
      const ctx = teach.getContext('2d');

      const hitCanvas = document.createElement('canvas');
      const hitCtx = hitCanvas.getContext('2d');

      const colorsHash = {};

      function getRandomColor() {
       const r = Math.round(Math.random() * 255);
       const g = Math.round(Math.random() * 255);
       const b = Math.round(Math.random() * 255);
       return `rgb(${r},${g},${b})`;
      }



      const circles = [{
        id: '1', x: 40, y: 40, radius: 30, color: '#f00'
      }, {
        id: '2', x: 200, y: 40, radius: 40, color: '#000'
      }];

      circles.forEach(circle => {
        while(true) {
           const colorKey = getRandomColor();
           if (!colorsHash[colorKey]) {
              circle.colorKey = colorKey;
              colorsHash[colorKey] = circle;
              return;
           }
        }
      });

      circles.forEach(circle => {
        ctx.beginPath();
        ctx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI, false);
        ctx.fillStyle = circle.color;
        ctx.fill();
        
        hitCtx.beginPath();
        hitCtx.arc(circle.x, circle.y, circle.radius, 0, 2 * Math.PI, false);
        hitCtx.fillStyle = circle.colorKey;
        hitCtx.fill();
      });

      function hasSameColor(color, shape) {
        return shape.color === color;
      }

      teach.addEventListener('click', (e) => {
        // const mousePos = {
        //   x: e.clientX - teach.offsetLeft,
        //   y: e.clientY - teach.offsetTop
        // };
      let {t,l} = getPagePoint(teach);
      let x=Math.round(e.pageX-l);
      let y=Math.round(e.pageY-t);
      let mousePos={x,y};

        const pixel = hitCtx.getImageData(mousePos.x, mousePos.y, 1, 1).data;
        const color = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
        const shape = colorsHash[color];
        if (shape) {
           alert('click on circle: ' + shape.id);
        }
      });
   </script>  
  <div class="canvas">
    <img src="res/aa.png" alt="">
    <p>this is p label</p>
   <canvas id="canvas" height="600" width="750"></canvas>
  
  </div>
  <script>
    var canvas = document.getElementById("canvas");
    var ctx1 = canvas.getContext("2d");

    canvas.addEventListener("mousemove", function(event){
      if(event.region) {
        alert("ouch, my eye :(");
      }
    });

    const circles1=[{
      id:1,x:140,y:120,radius:50,color:'#f00'
    },{
      id:2,x:190,y:300,radius:60,color:'#000'
    }];

    circles1.forEach(circle=>{
      ctx1.beginPath();
      ctx1.fillStyle=circle.color;
      ctx1.arc(circle.x,circle.y,circle.radius,0,Math.PI*2,false);
      ctx1.fill();
    })
    
    canvas.addEventListener("click",e=>{
      console.log(e.pageX,e.pageY)
      // debugger;
      const pos=pointToCanvas(e.pageX,e.pageY);
   
      circles1.forEach(item=>{
           console.log(pos,item)
        if(isInterrsect(pos,item)){
          return alert('click on circle:'+item.id)
        }
      })
    })

    /**圆周函数小于半径 **/
    function isInterrsect(point,circle){
      return Math.sqrt((point.x-circle.x)**2+(point.y-circle.y)**2)<circle.radius;
    }

    function pointToCanvas(x,y){
      let {t,l} = getPagePoint(canvas);
      // console.log('pointToCanvas',l,y);
      return {
        x:Math.round(x-l),
        y:Math.round(y-t),
      }
    }



  </script>
  <script>
    //原画布，区域画布
    const cavs=document.getElementById("cavs");
    const cx = cavs.getContext('2d');

    const ncavs=document.createElement('canvas');
    const ncx=ncavs.getContext('2d');
    ncavs.width=cavs.width;
    ncavs.height=cavs.height;

    const cars=[{
      id:3,x:140,y:120,src:'res/aa.png', color: 'rgb(255,0,0)'
    },{
      id:4,x:190,y:300,src:'res/car.png',color: 'rgb(0,255,0)'
    }];

       function getRandom(){
      const r = Math.round(Math.random()*255);
      const g = Math.round(Math.random()*255);
      const b = Math.round(Math.random()*255);
      return `rgb(${r},${g},${b})`;
    }

    const keysCache={};
    //缓存区域画布
    cars.forEach(car=>{
      while(true){
        let colorKey = getRandom();
        if(!keysCache[colorKey]){
          car.colorKey=colorKey;
          keysCache[colorKey]=car;
          return;
        }
      }
    })

     imagesLoaded(cars,function(){
          console.log('callback')
        }).then(res=>{
          
            cars.forEach(car=>{
              // cx.beginPath();
              // cx.arc(car.x, car.y, 100, 0, 2 * Math.PI, false);
              // cx.fillStyle = car.color;
              // cx.fill();

              // ncx.beginPath();
              // ncx.arc(car.x, car.y, 100, 0, 2 * Math.PI, false);
              // ncx.fillStyle = car.colorKey;
              // ncx.fill();
                cx.drawImage(car.img,car.x,car.y,100,100);

                // ncx.drawImage(car.img,car.x,car.y,100,100);
                ncx.fillStyle = car.colorKey;
                ncx.fillRect(car.x, car.y,100,100);
            })

        }).catch(c=>{
          console.log('catch',c);
        })

    cavs.addEventListener('click',(e)=>{
      
      let {t,l} = getPagePoint(cavs);
      let x=Math.round(e.pageX-l);
      let y=Math.round(e.pageY-t);
 
      const pixel = ncx.getImageData(x,y,1,1).data;
      const color = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
      const shape = keysCache[color];
      console.log(pixel)
      if(shape){
        alert('click:'+shape.src);
      }
    })



 


  //加载所有图片
    function imagesLoaded(cars,callback){
      var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
      return new Promise((resolve,reject)=>{
        let loaded=[];
        let broken=[];
        let proper=[];

        function doneLoading(){
          if(broken.length){
            reject({cars,proper,broken});
          }else{
            resolve(cars);
          }
          typeof callback=="function" && callback();
        }

        function imgLoaded(img,isBroken){
          loaded.push(img);
          if(isBroken){
            broken.push(img);
          }else{
            proper.push(img);
          }
          if(cars.length == loaded.length){
             setTimeout(doneLoading)
          }
        }

        if(!cars.length){
           doneLoading();
        }else{

          cars.forEach(car=>{
            let tempImg = new Image();
            tempImg.src=car.src||BLANK;
            car.img=tempImg;
            if(tempImg.complete && (tempImg.naturalWidth ===0 || tempImg.naturalWidth!=undefined)){
              imgLoaded(car,tempImg.naturalWidth === 0 || tempImg.naturalHeight === 0);
            }else{
              tempImg.onload=function(){
                imgLoaded(car,false);
              }
              tempImg.onerror=function(){
                imgLoaded(car,true);
              }
            }
          })
        }
        

        })
      
    }

  </script>
</body>
</html>